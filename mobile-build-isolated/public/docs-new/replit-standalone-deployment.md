# Next.js Standalone Deployment on Replit

This guide explains how to deploy Next.js applications using the standalone output mode on Replit.

## Understanding Standalone Deployment

Next.js 12+ introduced the standalone output option, which creates a minimal production build that includes only the necessary files to run your application. This is ideal for deployments on platforms like Replit, as it:

1. Reduces the size of the deployment package
2. Makes server startup faster
3. Provides better compatibility for serverless environments
4. Simplifies deployment by bundling dependencies

## Deployment Configuration

### Build Command

```
./replit-deploy.sh
```

The build script:

- Verifies environment variables
- Checks database connectivity
- Confirms middleware compatibility
- Runs TypeScript checks
- Optimizes Next.js configuration
- Creates a standalone build
- Ensures static assets are copied correctly

### Run Command

```
node .next/standalone/server.js
```

This command runs the standalone server generated by the Next.js build process.

## Environment Variables

Ensure the following environment variables are set:

- `DATABASE_URL`: Connection string for the PostgreSQL database
- `JWT_SECRET`: Secret key for JWT authentication
- `PORT`: Port for the server (defaults to 5000 if not set)
- `HOSTNAME`: Server hostname (automatically set by Replit)
- `NEXT_PUBLIC_API_BASE_URL`: Public API base URL (optional for staging)
- `NEXT_PUBLIC_APP_URL`: Public application URL (optional for staging)

### Automated Environment Variable Setup

We've created tools to automatically generate and configure environment variables for deployment:

1. Run `./prepare-replit-env.sh` to generate environment variables for Replit deployment

   - This will output the necessary variables to add to your Replit deployment settings
   - Copy these values to the Secrets section in the Replit deployment UI

2. During deployment, `./replit-deploy.sh` will:
   - Verify your environment variables are properly configured
   - Generate environment variables specifically for your Replit deployment
   - Save these variables to `.next/deployment/env-vars.txt` for reference
   - Set up default values where appropriate

## Troubleshooting

### Common Issues

1. **Cannot find module '/home/runner/workspace/.next/standalone/server.js'**

   - The standalone build wasn't properly created
   - Run `./verify-standalone.sh` to check and fix the build
   - Ensure `output: 'standalone'` is set in `next.config.mjs`

2. **ChunkLoadError: Loading chunk failed**

   - Static assets are missing in the standalone directory
   - Run `./replit-deploy.sh` which includes asset copying logic
   - Reduce code splitting in `next.config.mjs`

3. **Database connection issues**

   - Verify the `DATABASE_URL` is correctly set
   - Run `node verify-database.js` to test the connection

4. **Missing assets or styling**
   - Ensure public files are copied to the standalone directory
   - Check that `.next/static` is copied to `.next/standalone/.next/static`

### Verification and Utility Scripts

- `verify-env-variables.js`: Checks and sets up environment variables
  - Run with `--prepare` to set default values for missing variables
  - Run with `--export` to generate environment variables for deployment
- `prepare-replit-env.sh`: Generates environment variables for Replit deployment
- `fix-replit-deployment.js`: Comprehensive deployment diagnostics and solutions for common issues
  - Identifies configuration, build, and environment variable problems
  - Provides specific remediation steps for each identified issue
- `verify-database.js`: Tests database connectivity
- `verify-middleware.sh`: Confirms middleware compatibility
- `verify-standalone.sh`: Validates the standalone build structure
- `test-deployment.js`: Tests the deployed application

## Optimization Strategies

1. **Reduce Code Splitting**

   - Lower `maxInitialRequests` and `maxAsyncRequests` in webpack config
   - Use `maxSize` to limit chunk size
   - Group related modules together

2. **Increase Chunk Load Timeout**

   - Set `config.output.chunkLoadTimeout = 120000` (2 minutes)
   - Helps with slower network connections

3. **Use Deterministic Chunk IDs**

   - Set `moduleIds` and `chunkIds` to 'deterministic'
   - Improves caching and reduces rebuild times

4. **Copy Static Assets Correctly**
   - Ensure all public files are copied to the standalone directory
   - Copy `.next/static` to `.next/standalone/.next/static`
